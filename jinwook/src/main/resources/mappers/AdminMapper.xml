<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jinwook.home.mapper.AdminMapper">

	<resultMap type="store" id="storeSelectMap">
	   <result property="storeNo"  column="store_no"    jdbcType="INTEGER"/>
	   <result property="storeName"  column="store_name"    jdbcType="CHAR"/>
	   <result property="userId"  column="user_id"    jdbcType="CHAR"/>
	   <result property="storeAddr"  column="store_addr"    jdbcType="VARCHAR"/>
	   <result property="storePhone"  column="store_phone"    jdbcType="VARCHAR"/>   
	   <result property="user.userName"  column="user_name"    jdbcType="CHAR"/>      
	</resultMap>

	<sql id="usersColumns">
		  user_id
		, user_name
		, email
		, birth
		, gender
		, nick_name
		, phone
		, role
		, grade
		, business_no
		, blacklist_status
		, blacklist_reg_date
		, blacklist_end_date
		, reg_date
		, user_bye_status
	</sql>
	

	<!-- 유저 상세 -->
	<select id="getUserAdmin" parameterType="String" resultType="user">
		SELECT
			<include refid="usersColumns"/>
		FROM
			users
		WHERE
			user_id = #{userId}
	</select>
	
	
	<!-- 유저 목록 -->
	<select id="getUserListAdmin" parameterType="Criteria" resultType="User">
		SELECT
			user_id, user_name, phone, role
		FROM
			users
		WHERE
			user_bye_status = 0 
		ORDER BY 
			reg_date
		LIMIT
			#{paginationInfo.firstRecordIndex}, #{recordsPerPage}
		
	</select>
	
	
	<!-- 유저 목록 개수 -->
	<select id="getUserTotalCount" parameterType="Criteria" resultType="int">
		SELECT
			COUNT(*)
		FROM
			users
		WHERE
			user_bye_status = 0
	</select>
	
	
	<!-- 상점 목록 -->
	<select id="getStoreListAdmin" parameterType="Criteria" resultMap="storeSelectMap">
		SELECT
			 s.store_no, u.user_name, s.store_name, s.user_id, s.store_addr, s.store_phone
		FROM
			store s, users u
		WHERE 
			s.user_id = u.user_id
		ORDER BY 
			s.store_no
		LIMIT
			#{paginationInfo.firstRecordIndex}, #{recordsPerPage}
	</select>
	
	
	<!-- 상점 목록 개수 -->
	<select id="getStoreTotalCount" parameterType="Criteria" resultType="int">
		SELECT
			COUNT(*)
		FROM
			store
	</select>
	
	
	<!-- 신고 등록 -->
	<insert id="addComplain" parameterType="Complain">
			INSERT INTO complain 
			VALUES (
				  NULL
				, #{userId} <!-- 세션으로 받기 -->
				, #{complainId} <!-- 해당 게시글 통해 받기 -->
				, SYSDATE()
				, #{complainCode}
				, #{complainTarget} <!-- reqNo, commentNo,  -->
				, #{complainTargetNo} <!-- 컬럼 추가해야 할듯 ... reqNo, commentNo, reviewNo 받는 -->
			)
			
			<!-- 해당 게시글로 넘어갈 수 있는 메서드 필요... board에 있을듯 ... -->
	</insert>


	<!-- 신고 목록 -->
	<select id="getComplainListAdmin" parameterType="Criteria" resultType="Complain">
		SELECT
			 *
		FROM
			complain
		ORDER BY 
			complain_no
		LIMIT
			#{paginationInfo.firstRecordIndex}, #{recordsPerPage}
	</select>
	
	
	<!-- 신고 목록 개수 -->
	<select id="getComplainTotalCount" parameterType="Criteria" resultType="int">
		SELECT
			COUNT(*)
		FROM
			complain
	</select>
	
	<!-- 대기중인 신고 목록 개수 -->
	<select id="getComplainTotalCountAll"  resultType="int">
		SELECT
			COUNT(*)
		FROM
			complain
		WHERE
			complain_status = 0
	</select>
	
	
	<!-- 블랙리스트 등록 -->
	<update id="updateBlacklist" parameterType="Complain">
		UPDATE users
		<set>
			blacklist_status = true,
			blacklist_reg_date = SYSDATE(),
			<if test= 'user.blackPeriod == "7days"'>
			blacklist_end_date = DATE_ADD(DATE(NOW()), INTERVAL +7 DAY)
			</if>
			<if test= 'user.blackPeriod == "1month"'>
			blacklist_end_date = DATE_ADD(DATE(NOW()), INTERVAL +1 MONTH)
			</if>
			<if test= 'user.blackPeriod == "6month"'>
			blacklist_end_date = DATE_ADD(DATE(NOW()), INTERVAL +6 MONTH)
			</if>
			<if test= 'user.blackPeriod == "1year"'>
			blacklist_end_date = DATE_ADD(DATE(NOW()), INTERVAL +1 YEAR)
			</if>
		</set>
		WHERE
			user_id = #{user.userId}
	</update>
	
	
	<!-- complainStatus 변경 (false->true) -->
	<update id="updateComplainStatus" parameterType="Complain">
		UPDATE complain
		SET
			complain_status = true
		WHERE
			complain_no = #{complanNo}
	</update>
	
	
	
	<!-- 블랙리스트 목록 -->
	<select id="getBlacklistAdmin" parameterType="User" resultType="User">
		SELECT
			u.user_id, u.user_name, u.nick_name, u.birth, u.gender, u.email, u.phone, u.blacklist_reg_date, u.blacklist_end_date, c.complain_code 
		FROM
			users u, complain c
		WHERE
			u.user_id = c.user_id
			AND
			user_bye_status = 0
			AND 
			u.blacklist_status = true
	</select>
	
	
	<!-- 블랙리스트 목록 개수 -->
	<select id="getBlacklistTotalCount" parameterType="User" resultType="int">
		SELECT
			COUNT(*)
		FROM
			users
		WHERE
			blacklist_status = true
			AND
			user_bye_status = 0
	</select>
	
	
	<!-- 대기중인 문의 목록 개수 -->
	<select id="getWatingInquiryCount" resultType="int">
		SELECT
			COUNT(*)
		FROM
			board
		WHERE
			board_inq_status = 0
	</select>
	

</mapper>